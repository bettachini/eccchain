#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>

#include "MersenneTwister.h"


#define WORDLEN 8

#define DATABITS 8
#define DATALEN 256 // 2^DATABITS

#define MAXSYMBOL 3 // trinary
unsigned char sigdigit[][8]={
/*
 {'0','0','0','0','0','0','0','0'},
 {'1','0','0','0','0','0','0','0'},
 {'2','0','0','0','0','0','0','0'},
 {'0','1','0','0','0','0','0','0'},
 {'0','2','0','0','0','0','0','0'},
 {'0','0','1','0','0','0','0','0'},
 {'0','0','2','0','0','0','0','0'},
 {'0','0','0','1','0','0','0','0'},
 {'0','0','0','2','0','0','0','0'},
 {'0','0','0','0','1','0','0','0'},
 {'0','0','0','0','2','0','0','0'},
 {'0','0','0','0','0','1','0','0'},
 {'0','0','0','0','0','2','0','0'},
 {'0','0','0','0','0','0','1','0'},
 {'0','0','0','0','0','0','2','0'},
 {'0','0','0','0','0','0','0','1'},
 {'0','0','0','0','0','0','0','2'},
 {'1','1','0','0','0','0','0','0'},
 {'2','1','0','0','0','0','0','0'},
 {'1','2','0','0','0','0','0','0'},
 {'2','2','0','0','0','0','0','0'},
 {'1','0','1','0','0','0','0','0'},
 {'2','0','1','0','0','0','0','0'},
 {'0','1','1','0','0','0','0','0'},
 {'0','2','1','0','0','0','0','0'},
 {'1','0','2','0','0','0','0','0'},
 {'2','0','2','0','0','0','0','0'},
 {'0','1','2','0','0','0','0','0'},
 {'0','2','2','0','0','0','0','0'},
 {'1','0','0','1','0','0','0','0'},
 {'2','0','0','1','0','0','0','0'},
 {'0','1','0','1','0','0','0','0'},
 {'0','2','0','1','0','0','0','0'},
 {'0','0','1','1','0','0','0','0'},
 {'0','0','2','1','0','0','0','0'},
 {'1','0','0','2','0','0','0','0'},
 {'2','0','0','2','0','0','0','0'},
 {'0','1','0','2','0','0','0','0'},
 {'0','2','0','2','0','0','0','0'},
 {'0','0','1','2','0','0','0','0'},
 {'0','0','2','2','0','0','0','0'},
 {'1','0','0','0','1','0','0','0'},
 {'2','0','0','0','1','0','0','0'},
 {'0','1','0','0','1','0','0','0'},
 {'0','2','0','0','1','0','0','0'},
 {'0','0','1','0','1','0','0','0'},
 {'0','0','2','0','1','0','0','0'},
 {'0','0','0','1','1','0','0','0'},
 {'0','0','0','2','1','0','0','0'},
 {'1','0','0','0','2','0','0','0'},
 {'2','0','0','0','2','0','0','0'},
 {'0','1','0','0','2','0','0','0'},
 {'0','2','0','0','2','0','0','0'},
 {'0','0','1','0','2','0','0','0'},
 {'0','0','2','0','2','0','0','0'},
 {'0','0','0','1','2','0','0','0'},
 {'0','0','0','2','2','0','0','0'},
 {'1','0','0','0','0','1','0','0'},
 {'2','0','0','0','0','1','0','0'},
 {'0','1','0','0','0','1','0','0'},
 {'0','2','0','0','0','1','0','0'},
 {'0','0','1','0','0','1','0','0'},
 {'0','0','2','0','0','1','0','0'},
 {'0','0','0','1','0','1','0','0'},
 {'0','0','0','2','0','1','0','0'},
 {'0','0','0','0','1','1','0','0'},
 {'0','0','0','0','2','1','0','0'},
 {'1','0','0','0','0','2','0','0'},
 {'2','0','0','0','0','2','0','0'},
 {'0','1','0','0','0','2','0','0'},
 {'0','2','0','0','0','2','0','0'},
 {'0','0','1','0','0','2','0','0'},
 {'0','0','2','0','0','2','0','0'},
 {'0','0','0','1','0','2','0','0'},
 {'0','0','0','2','0','2','0','0'},
 {'0','0','0','0','1','2','0','0'},
 {'0','0','0','0','2','2','0','0'},
 {'1','0','0','0','0','0','1','0'},
 {'2','0','0','0','0','0','1','0'},
 {'0','1','0','0','0','0','1','0'},
 {'0','2','0','0','0','0','1','0'},
 {'0','0','1','0','0','0','1','0'},
 {'0','0','2','0','0','0','1','0'},
 {'0','0','0','1','0','0','1','0'},
 {'0','0','0','2','0','0','1','0'},
 {'0','0','0','0','1','0','1','0'},
 {'0','0','0','0','2','0','1','0'},
 {'0','0','0','0','0','1','1','0'},
 {'0','0','0','0','0','2','1','0'},
 {'1','0','0','0','0','0','2','0'},
 {'2','0','0','0','0','0','2','0'},
 {'0','1','0','0','0','0','2','0'},
 {'0','2','0','0','0','0','2','0'},
 {'0','0','1','0','0','0','2','0'},
 {'0','0','2','0','0','0','2','0'},
 {'0','0','0','1','0','0','2','0'},
 {'0','0','0','2','0','0','2','0'},
 {'0','0','0','0','1','0','2','0'},
 {'0','0','0','0','2','0','2','0'},
 {'0','0','0','0','0','1','2','0'},
 {'0','0','0','0','0','2','2','0'},
 {'1','0','0','0','0','0','0','1'},
 {'2','0','0','0','0','0','0','1'},
 {'0','1','0','0','0','0','0','1'},
 {'0','2','0','0','0','0','0','1'},
 {'0','0','1','0','0','0','0','1'},
 {'0','0','2','0','0','0','0','1'},
 {'0','0','0','1','0','0','0','1'},
 {'0','0','0','2','0','0','0','1'},
 {'0','0','0','0','1','0','0','1'},
 {'0','0','0','0','2','0','0','1'},
 {'0','0','0','0','0','1','0','1'},
 {'0','0','0','0','0','2','0','1'},
 {'0','0','0','0','0','0','1','1'},
 {'0','0','0','0','0','0','2','1'},
 {'1','0','0','0','0','0','0','2'},
 {'2','0','0','0','0','0','0','2'},
 {'0','1','0','0','0','0','0','2'},
 {'0','2','0','0','0','0','0','2'},
 {'0','0','1','0','0','0','0','2'},
 {'0','0','2','0','0','0','0','2'},
 {'0','0','0','1','0','0','0','2'},
 {'0','0','0','2','0','0','0','2'},
 {'0','0','0','0','1','0','0','2'},
 {'0','0','0','0','2','0','0','2'},
 {'0','0','0','0','0','1','0','2'},
 {'0','0','0','0','0','2','0','2'},
 {'0','0','0','0','0','0','1','2'},
 {'0','0','0','0','0','0','2','2'}
*/

 {'0','0','0','0','0','0','0','0'},
 {'1','0','0','0','0','0','0','0'},
 {'2','0','0','0','0','0','0','0'},
 {'3','0','0','0','0','0','0','0'},
 {'0','1','0','0','0','0','0','0'},
 {'0','2','0','0','0','0','0','0'},
 {'0','3','0','0','0','0','0','0'},
 {'0','0','1','0','0','0','0','0'},
 {'0','0','2','0','0','0','0','0'},
 {'0','0','3','0','0','0','0','0'},
 {'0','0','0','1','0','0','0','0'},
 {'0','0','0','2','0','0','0','0'},
 {'0','0','0','3','0','0','0','0'},
 {'0','0','0','0','1','0','0','0'},
 {'0','0','0','0','2','0','0','0'},
 {'0','0','0','0','3','0','0','0'},
 {'0','0','0','0','0','1','0','0'},
 {'0','0','0','0','0','2','0','0'},
 {'0','0','0','0','0','3','0','0'},
 {'0','0','0','0','0','0','1','0'},
 {'0','0','0','0','0','0','2','0'},
 {'0','0','0','0','0','0','3','0'},
 {'0','0','0','0','0','0','0','1'},
 {'0','0','0','0','0','0','0','2'},
 {'0','0','0','0','0','0','0','3'},
 {'1','1','0','0','0','0','0','0'},
 {'2','1','0','0','0','0','0','0'},
 {'3','1','0','0','0','0','0','0'},
 {'1','2','0','0','0','0','0','0'},
 {'2','2','0','0','0','0','0','0'},
 {'3','2','0','0','0','0','0','0'},
 {'1','3','0','0','0','0','0','0'},
 {'2','3','0','0','0','0','0','0'},
 {'3','3','0','0','0','0','0','0'},
 {'1','0','1','0','0','0','0','0'},
 {'2','0','1','0','0','0','0','0'},
 {'3','0','1','0','0','0','0','0'},
 {'0','1','1','0','0','0','0','0'},
 {'0','2','1','0','0','0','0','0'},
 {'0','3','1','0','0','0','0','0'},
 {'1','0','2','0','0','0','0','0'},
 {'2','0','2','0','0','0','0','0'},
 {'3','0','2','0','0','0','0','0'},
 {'0','1','2','0','0','0','0','0'},
 {'0','2','2','0','0','0','0','0'},
 {'0','3','2','0','0','0','0','0'},
 {'1','0','3','0','0','0','0','0'},
 {'2','0','3','0','0','0','0','0'},
 {'3','0','3','0','0','0','0','0'},
 {'0','1','3','0','0','0','0','0'},
 {'0','2','3','0','0','0','0','0'},
 {'0','3','3','0','0','0','0','0'},
 {'1','0','0','1','0','0','0','0'},
 {'2','0','0','1','0','0','0','0'},
 {'3','0','0','1','0','0','0','0'},
 {'0','1','0','1','0','0','0','0'},
 {'0','2','0','1','0','0','0','0'},
 {'0','3','0','1','0','0','0','0'},
 {'0','0','1','1','0','0','0','0'},
 {'0','0','2','1','0','0','0','0'},
 {'0','0','3','1','0','0','0','0'},
 {'1','0','0','2','0','0','0','0'},
 {'2','0','0','2','0','0','0','0'},
 {'3','0','0','2','0','0','0','0'},
 {'0','1','0','2','0','0','0','0'},
 {'0','2','0','2','0','0','0','0'},
 {'0','3','0','2','0','0','0','0'},
 {'0','0','1','2','0','0','0','0'},
 {'0','0','2','2','0','0','0','0'},
 {'0','0','3','2','0','0','0','0'},
 {'1','0','0','3','0','0','0','0'},
 {'2','0','0','3','0','0','0','0'},
 {'3','0','0','3','0','0','0','0'},
 {'0','1','0','3','0','0','0','0'},
 {'0','2','0','3','0','0','0','0'},
 {'0','3','0','3','0','0','0','0'},
 {'0','0','1','3','0','0','0','0'},
 {'0','0','2','3','0','0','0','0'},
 {'0','0','3','3','0','0','0','0'},
 {'1','0','0','0','1','0','0','0'},
 {'2','0','0','0','1','0','0','0'},
 {'3','0','0','0','1','0','0','0'},
 {'0','1','0','0','1','0','0','0'},
 {'0','2','0','0','1','0','0','0'},
 {'0','3','0','0','1','0','0','0'},
 {'0','0','1','0','1','0','0','0'},
 {'0','0','2','0','1','0','0','0'},
 {'0','0','3','0','1','0','0','0'},
 {'0','0','0','1','1','0','0','0'},
 {'0','0','0','2','1','0','0','0'},
 {'0','0','0','3','1','0','0','0'},
 {'1','0','0','0','2','0','0','0'},
 {'2','0','0','0','2','0','0','0'},
 {'3','0','0','0','2','0','0','0'},
 {'0','1','0','0','2','0','0','0'},
 {'0','2','0','0','2','0','0','0'},
 {'0','3','0','0','2','0','0','0'},
 {'0','0','1','0','2','0','0','0'},
 {'0','0','2','0','2','0','0','0'},
 {'0','0','3','0','2','0','0','0'},
 {'0','0','0','1','2','0','0','0'},
 {'0','0','0','2','2','0','0','0'},
 {'0','0','0','3','2','0','0','0'},
 {'1','0','0','0','3','0','0','0'},
 {'2','0','0','0','3','0','0','0'},
 {'3','0','0','0','3','0','0','0'},
 {'0','1','0','0','3','0','0','0'},
 {'0','2','0','0','3','0','0','0'},
 {'0','3','0','0','3','0','0','0'},
 {'0','0','1','0','3','0','0','0'},
 {'0','0','2','0','3','0','0','0'},
 {'0','0','3','0','3','0','0','0'},
 {'0','0','0','1','3','0','0','0'},
 {'0','0','0','2','3','0','0','0'},
 {'0','0','0','3','3','0','0','0'},
 {'1','0','0','0','0','1','0','0'},
 {'2','0','0','0','0','1','0','0'},
 {'3','0','0','0','0','1','0','0'},
 {'0','1','0','0','0','1','0','0'},
 {'0','2','0','0','0','1','0','0'},
 {'0','3','0','0','0','1','0','0'},
 {'0','0','1','0','0','1','0','0'},
 {'0','0','2','0','0','1','0','0'},
 {'0','0','3','0','0','1','0','0'},
 {'0','0','0','1','0','1','0','0'},
 {'0','0','0','2','0','1','0','0'},
 {'0','0','0','3','0','1','0','0'},
 {'0','0','0','0','1','1','0','0'},
 {'0','0','0','0','2','1','0','0'},
 {'0','0','0','0','3','1','0','0'},
 {'1','0','0','0','0','2','0','0'},
 {'2','0','0','0','0','2','0','0'},
 {'3','0','0','0','0','2','0','0'},
 {'0','1','0','0','0','2','0','0'},
 {'0','2','0','0','0','2','0','0'},
 {'0','3','0','0','0','2','0','0'},
 {'0','0','1','0','0','2','0','0'},
 {'0','0','2','0','0','2','0','0'},
 {'0','0','3','0','0','2','0','0'},
 {'0','0','0','1','0','2','0','0'},
 {'0','0','0','2','0','2','0','0'},
 {'0','0','0','3','0','2','0','0'},
 {'0','0','0','0','1','2','0','0'},
 {'0','0','0','0','2','2','0','0'},
 {'0','0','0','0','3','2','0','0'},
 {'1','0','0','0','0','3','0','0'},
 {'2','0','0','0','0','3','0','0'},
 {'3','0','0','0','0','3','0','0'},
 {'0','1','0','0','0','3','0','0'},
 {'0','2','0','0','0','3','0','0'},
 {'0','3','0','0','0','3','0','0'},
 {'0','0','1','0','0','3','0','0'},
 {'0','0','2','0','0','3','0','0'},
 {'0','0','3','0','0','3','0','0'},
 {'0','0','0','1','0','3','0','0'},
 {'0','0','0','2','0','3','0','0'},
 {'0','0','0','3','0','3','0','0'},
 {'0','0','0','0','1','3','0','0'},
 {'0','0','0','0','2','3','0','0'},
 {'0','0','0','0','3','3','0','0'},
 {'1','0','0','0','0','0','1','0'},
 {'2','0','0','0','0','0','1','0'},
 {'3','0','0','0','0','0','1','0'},
 {'0','1','0','0','0','0','1','0'},
 {'0','2','0','0','0','0','1','0'},
 {'0','3','0','0','0','0','1','0'},
 {'0','0','1','0','0','0','1','0'},
 {'0','0','2','0','0','0','1','0'},
 {'0','0','3','0','0','0','1','0'},
 {'0','0','0','1','0','0','1','0'},
 {'0','0','0','2','0','0','1','0'},
 {'0','0','0','3','0','0','1','0'},
 {'0','0','0','0','1','0','1','0'},
 {'0','0','0','0','2','0','1','0'},
 {'0','0','0','0','3','0','1','0'},
 {'0','0','0','0','0','1','1','0'},
 {'0','0','0','0','0','2','1','0'},
 {'0','0','0','0','0','3','1','0'},
 {'1','0','0','0','0','0','2','0'},
 {'2','0','0','0','0','0','2','0'},
 {'3','0','0','0','0','0','2','0'},
 {'0','1','0','0','0','0','2','0'},
 {'0','2','0','0','0','0','2','0'},
 {'0','3','0','0','0','0','2','0'},
 {'0','0','1','0','0','0','2','0'},
 {'0','0','2','0','0','0','2','0'},
 {'0','0','3','0','0','0','2','0'},
 {'0','0','0','1','0','0','2','0'},
 {'0','0','0','2','0','0','2','0'},
 {'0','0','0','3','0','0','2','0'},
 {'0','0','0','0','1','0','2','0'},
 {'0','0','0','0','2','0','2','0'},
 {'0','0','0','0','3','0','2','0'},
 {'0','0','0','0','0','1','2','0'},
 {'0','0','0','0','0','2','2','0'},
 {'0','0','0','0','0','3','2','0'},
 {'1','0','0','0','0','0','3','0'},
 {'2','0','0','0','0','0','3','0'},
 {'3','0','0','0','0','0','3','0'},
 {'0','1','0','0','0','0','3','0'},
 {'0','2','0','0','0','0','3','0'},
 {'0','3','0','0','0','0','3','0'},
 {'0','0','1','0','0','0','3','0'},
 {'0','0','2','0','0','0','3','0'},
 {'0','0','3','0','0','0','3','0'},
 {'0','0','0','1','0','0','3','0'},
 {'0','0','0','2','0','0','3','0'},
 {'0','0','0','3','0','0','3','0'},
 {'0','0','0','0','1','0','3','0'},
 {'0','0','0','0','2','0','3','0'},
 {'0','0','0','0','3','0','3','0'},
 {'0','0','0','0','0','1','3','0'},
 {'0','0','0','0','0','2','3','0'},
 {'0','0','0','0','0','3','3','0'},
 {'1','0','0','0','0','0','0','1'},
 {'2','0','0','0','0','0','0','1'},
 {'3','0','0','0','0','0','0','1'},
 {'0','1','0','0','0','0','0','1'},
 {'0','2','0','0','0','0','0','1'},
 {'0','3','0','0','0','0','0','1'},
 {'0','0','1','0','0','0','0','1'},
 {'0','0','2','0','0','0','0','1'},
 {'0','0','3','0','0','0','0','1'},
 {'0','0','0','1','0','0','0','1'},
 {'0','0','0','2','0','0','0','1'},
 {'0','0','0','3','0','0','0','1'},
 {'0','0','0','0','1','0','0','1'},
 {'0','0','0','0','2','0','0','1'},
 {'0','0','0','0','3','0','0','1'},
 {'0','0','0','0','0','1','0','1'},
 {'0','0','0','0','0','2','0','1'},
 {'0','0','0','0','0','3','0','1'},
 {'0','0','0','0','0','0','1','1'},
 {'0','0','0','0','0','0','2','1'},
 {'0','0','0','0','0','0','3','1'},
 {'1','0','0','0','0','0','0','2'},
 {'2','0','0','0','0','0','0','2'},
 {'3','0','0','0','0','0','0','2'},
 {'0','1','0','0','0','0','0','2'},
 {'0','2','0','0','0','0','0','2'},
 {'0','3','0','0','0','0','0','2'},
 {'0','0','1','0','0','0','0','2'},
 {'0','0','2','0','0','0','0','2'},
 {'0','0','3','0','0','0','0','2'},
 {'0','0','0','1','0','0','0','2'},
 {'0','0','0','2','0','0','0','2'},
 {'0','0','0','3','0','0','0','2'},
 {'0','0','0','0','1','0','0','2'},
 {'0','0','0','0','2','0','0','2'},
 {'0','0','0','0','3','0','0','2'},
 {'0','0','0','0','0','1','0','2'},
 {'0','0','0','0','0','2','0','2'},
 {'0','0','0','0','0','3','0','2'},
 {'0','0','0','0','0','0','1','2'},
 {'0','0','0','0','0','0','2','2'},
 {'0','0','0','0','0','0','3','2'},
 {'1','0','0','0','0','0','0','3'},
 {'2','0','0','0','0','0','0','3'},
 {'3','0','0','0','0','0','0','3'},
 {'0','1','0','0','0','0','0','3'},
 {'0','2','0','0','0','0','0','3'},
 {'0','3','0','0','0','0','0','3'},
 {'0','0','1','0','0','0','0','3'},
 {'0','0','2','0','0','0','0','3'},
 {'0','0','3','0','0','0','0','3'},
 {'0','0','0','1','0','0','0','3'},
 {'0','0','0','2','0','0','0','3'},
 {'0','0','0','3','0','0','0','3'},
 {'0','0','0','0','1','0','0','3'},
 {'0','0','0','0','2','0','0','3'},
 {'0','0','0','0','3','0','0','3'},
 {'0','0','0','0','0','1','0','3'},
 {'0','0','0','0','0','2','0','3'},
 {'0','0','0','0','0','3','0','3'},
 {'0','0','0','0','0','0','1','3'},
 {'0','0','0','0','0','0','2','3'},
 {'0','0','0','0','0','0','3','3'}

};

MTRand mtrand((long unsigned int)0);
unsigned int irand(void)	{ return mtrand.randInt();}

void lfsr(unsigned short int *reg)      {
        *reg = mtrand.randInt() & 0xFFFF;
        }



        #define M 205
        #define K 9
        #define CLIENTS M
        #define DEBUG 0

unsigned int bits2Number(unsigned char *bit, unsigned bitcount)
{
unsigned int i,ret;
ret=0;
unsigned int c=1;
for(i=0;i<bitcount;i++,c+=c)
	if (bit[i]=='1') ret+=c;
return ret;
}
int rrr=0;

void bloomenc(unsigned char *bit,unsigned bitcount,unsigned char *bloomFilter, unsigned clients)
	{
        unsigned int i,q,k;
        unsigned char clientData[CLIENTS][bitcount]; // Datos a transmitir

        /* Seeds para el lfsr */
        unsigned short int clientSeeds[CLIENTS][K];
	/* Posiciones de nuestro bloomfilter */
	unsigned short int clientPos[K*MAXSYMBOL];
	unsigned short int tmp[K*MAXSYMBOL];

        /* Inicializamos PRNG de los clientes */
        for(i=0;i<clients;i++)
                for (q=0;q<K;q++)
                        clientSeeds[i][q]=irand() & 0xffff;

                /* Inicializamos BloomFilter */
		memset(bloomFilter,0,M);

                /* Generamos datos random */
                for(i=0;i<clients;i++)
			for (q=0;q<bitcount;q++)
                        	clientData[i][q]=irand() & 1;

                /* El cliente 0 tiene los datos reales */
		for (q=0;q<bitcount;q++) {
                	clientData[0][q]=bit[q]-0x30;
			}
                /* Simulamos transmision */
                for(i=0;i<clients;i++)
                        for (k=0;k<K;k++)       {
                        /* Averiguamos posicion en la que tenemos que marcar */
                        lfsr(&clientSeeds[i][k]);
                        unsigned int pos = (clientSeeds[i][k] % M);// & 0xfffffffe;
			/* Guardamos posicion de nuestro cliente */
			if (!i)	clientPos[k]=pos;
                        if (DEBUG)
                                fprintf(stderr,"Pos[%d][%d]: %d\n",i,k,pos);
                        /* Marcamos la posicion que corresponda */
			for (q=0;q<bitcount;q++) { 
				if (i==0) //cliente real
				   {
					//positivo
	                           if(clientData[i][q])
        	                        bloomFilter[ (pos+clientData[i][q]-1) % M ]++;
				   }
				else    {
					unsigned int val = irand();
					rrr++;
					int rval = sigdigit[val % DATALEN][rrr % WORDLEN]-0x30;
	                           	if(rval)
        	        	                bloomFilter[ (pos+rval-1) % M ]++;
					}
				}
                        }
                if (DEBUG)
                        for(i=0;i<sizeof(bloomFilter);i++)
                                printf("bloomFilter[%d]=%d\n",i,bloomFilter[i]);
		/* Copiamos a la salida solamente los bits que corresponden a nuestro cliente */
		for (k=0;k<K;k++)
			for (i=0;i<MAXSYMBOL;i++) 
				tmp[k*MAXSYMBOL+i]=bloomFilter[ (clientPos[k]+i) % M];
			
		for (k=0;k<K*MAXSYMBOL;k++) 
			bloomFilter[k]=tmp[k];
	}

void bloomdec(unsigned char *bit,unsigned bitcount,unsigned char *bloomFilter, unsigned clients)
        {
        unsigned int i,q,k;
        unsigned char clientDataReceived[CLIENTS][bitcount]; // Datos recibidos

		q=0;
                /* Ahora en el bloomfilter tenemos todos los datos, tratamos de descifrarlos: */
                        /* Caso por defecto: Uno */
			int vend[MAXSYMBOL];
			//inicializacion
			for (i=0;i<MAXSYMBOL;i++)
				vend[i]=1;
			//AND de todos los bits de bloomFilter
                        for (k=0;k<K;k++)
				for (i=0;i<MAXSYMBOL;i++)
					if (!bloomFilter[k*MAXSYMBOL+i]) vend[i]=0;

			// Decodificacion del resultado
			unsigned int count=0;
			for (i=0;i<MAXSYMBOL;i++)
				count+=vend[i]*((i+1)*100);

			clientDataReceived[0][q]=0;
			for (i=0;i<MAXSYMBOL;i++)
				if (count==(i+1)*100)
					clientDataReceived[0][q]=i+1;

			if (count && (!clientDataReceived[0][q]))
				clientDataReceived[0][q]=1; // caso por defecto cuando no se sabe bien que quedo

	for (q=0;q<bitcount;q++)
		bit[q] = clientDataReceived[0][q];
	}

void usage(void)	{
	printf("Usage: bfenc <clients> (takes input from stdin and outputs to stdout)\n");
	exit(1);
}

// Dado un word en sigdigit, lo convierte en el mas parecido en el array
int searchSimilarCode(unsigned char *rin) {
		// buscamos codigo mas similar
		int hammdist=-999;
		int selected=0;
		int dist,i,q,testdigit;
		for (q=0;q<DATALEN;q++)	{
			dist=0;
			for (i=0;i<WORDLEN;i++)  {
				testdigit=sigdigit[q][i]-0x30;
				if (testdigit==rin[i]) dist++;
				if ( (rin[i]==0) && (testdigit==1)) dist=-2000;
				if ( (rin[i]==0) && (testdigit==2)) dist=-2000;
				if ( (rin[i]==1) && (testdigit==2)) dist=-2000;
				if ( (rin[i]==2) && (testdigit==1)) dist=-2000;
				}

			if (dist>hammdist) {
				hammdist=dist;
				selected=q;
				}
			}
		for (i=0;i<WORDLEN;i++)	{
			rin[i]=sigdigit[selected][i]-0x30;
			}
		return selected;
}

// Pasa de binario signed digit a binario normal, devuelve el valor en decimal
int toNormalBinary(unsigned char *sigbin,unsigned char *bin)	{
		int count,i;
		count=searchSimilarCode(sigbin);
		for (i=0;i<DATABITS;i++)	
			bin[i]=((count&(1<<i))!=0)+0x30;
		return count;
		}

int main(int argc, char **argv) 
{
int len,i;
unsigned char in[DATABITS];
unsigned char rin[WORDLEN];
unsigned char out[M];

int clients=128;

srand(0);

if (argc<2)	usage();

clients=atoi(argv[1]);

fprintf(stderr,"bloomfilter: %d clients \n",clients);

if (strstr(argv[0],"bfenc"))
	{ // codifica un canal en un bloomfilter
	memset(in,0,sizeof(in));
	memset(out,0,sizeof(out));
	int cnt=0,err;
	while((len=fread(&in,DATABITS,1,stdin))==1)	{
			unsigned int cdata = bits2Number(in,DATABITS);
			err=0;
			for (i=0;i<WORDLEN;i++)	{
				bloomenc(&sigdigit[cdata][i],1,out,clients);
				if ((len=write(1,out,K*MAXSYMBOL)) !=K*MAXSYMBOL)
					fprintf(stderr,"Error: write\n");
				//bloomdec(&rin[i],1,out,clients);
				
				/*if (rin[i]!=sigdigit[cdata][i]-0x30) {
					fprintf(stderr,"E");
					cnt++;
					err=1;
					}
				*/
				}
			/*
			if (err==3)	{
				fprintf(stderr,"\nOrig: ");
				for (i=0;i<WORDLEN;i++) fprintf(stderr,"%d",sigdigit[cdata][i]-0x30);
				fprintf(stderr,"-Post bf: ");
				for (i=0;i<WORDLEN;i++) fprintf(stderr,"%d",rin[i]);
				fprintf(stderr,"-Simil: ");
				for (i=0;i<WORDLEN;i++) fprintf(stderr,"%d",rin[i]);
	//			searchSimilarCode(rin);
				unsigned int count=toNormalBinary(rin,in);
				fprintf(stderr," %d - %d\n",cdata,count);
				}*/
		}
	fprintf(stderr,"Total error: %d\n",cnt);
	}
else	{// decodifica un bloomfilter en un canal
	while (1)	{
		unsigned int count=0;
		// decodificamos
		for (i=0;i<WORDLEN;i++)	{
			len=fread(out,1,K*MAXSYMBOL,stdin);
			if (len!=K*MAXSYMBOL) return 0;
			bloomdec(&rin[i],1,out,clients);
			}
		count=toNormalBinary(rin,in);
		if ((len=write(1,in,DATABITS)) !=DATABITS)
			fprintf(stderr,"Error: write\n");
		}
	}
return 0;
}

